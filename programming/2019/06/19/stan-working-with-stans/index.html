<!DOCTYPE html>
<html>

  <head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-39729658-3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-39729658-3');
</script>


  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Stan working with Stan</title>
  <meta name="description" content="Stan is a language used for statistical inference. Here we will investigate estimating the unknown length of a pendulum based on measurements of velocity and...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://szonov.com/programming/2019/06/19/stan-working-with-stans/">
  <link rel="alternate" type="application/rss+xml" title="Stan Zonov" href="https://szonov.com/feed.xml" />
</head>


  <body>
	
    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">Stan Zonov</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
	<a class="page-link" href=""></a>
        
		
			<a class="page-link" href="/about/">About</a>
		
        
		
			
		
        
		
			
		
        
		
			
		
        
		
			
		
        
		
			
		
        
		
			
		
        
		
			
		
        
		
			
		
        
		
			
		
        
		
			
		
        
		
			
		
        
		
			
		
        
		
			
		
        
		
			
		
        
		
			
		
        
		
			
		
        
		
			
		
        
		
			
		
        
		
			
		
        
		
			
		
        
		
			
		
        
		
			
		
        
		
			
		
        
		
			
		
        
		
			
		
        
		
			
		
        
		
			
		
        
		
			
		
        
		
			
		
        
		
			
		
        
		
			<a class="page-link" href="/photos/">Photos</a>
		
        
          <a class="page-link" href="/programming/2019/06/19/stan-working-with-stans/">Blog</a>
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
 	 
      <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    TeX: {
      equationNumbers: {
        autoNumber: "AMS"
      }
    },
    tex2jax: {
      inlineMath: [ ['$','$'], ['\(', '\)'] ],
      displayMath: [ ['$$','$$'] ],
      processEscapes: true,
    }
  });
</script>
<script type="text/javascript"
        src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

    
    <h1 class="post-title">Stan working with Stan</h1>
    <p class="post-meta">Jun 19, 2019</p>
  </header>

  <article class="post-content">
    <p><a href="https://mc-stan.org/">Stan</a> is a language used for statistical inference. Here we will investigate estimating the unknown length of a pendulum based on measurements of velocity and angle $\theta$. Two good examples to get started with <code class="language-plaintext highlighter-rouge">Stan</code> are</p>

<ol>
  <li><a href="https://ourcodingclub.github.io/2018/04/17/stan-intro.html">Intro to Stan</a></li>
  <li><a href="https://mc-stan.org/users/documentation/case-studies/lotka-volterra-predator-prey.html">Predator-Prey Population Dynamics</a>:</li>
</ol>

<p>Here Stan will be used to estimate parameters - specifically the length of pendulum. Consider the pendulum equation</p>

<p>$ \frac{d^2 \theta}{d t^2} + \frac{g}{l} \sin(\theta) = 0$,</p>

<p>where $\theta$ is the angle of the pendulum, $g$ gravitational constant, $l$ is the pendulum length and $t$ is time. With damping added, the equation is now</p>

<p>$ \frac{d^2 \theta}{d t^2} + \frac{g}{l} \sin(\theta) + s \frac{d \theta}{d t} = 0$,</p>

<p>where $s$ is a damping constant.</p>

<p>Letting $v = \frac{d \theta}{dt}$, we get the following system of differential equations:</p>

<p>$\frac{d v}{dt} = - \frac{g}{l} \sin(\theta) - s v$</p>

<p>$\frac{d \theta}{dt} = v$.</p>

<p>We can encode the DEs in <code class="language-plaintext highlighter-rouge">Stan</code> as follows:</p>

<figure class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="n">functions</span> <span class="p">{</span>
	<span class="n">real</span><span class="p">[]</span> <span class="n">dz_dt</span><span class="p">(</span><span class="n">real</span> <span class="n">t</span><span class="p">,</span> <span class="n">real</span><span class="p">[]</span> <span class="n">z</span><span class="p">,</span> <span class="n">real</span><span class="p">[]</span> <span class="n">params</span><span class="p">,</span> <span class="n">real</span><span class="p">[]</span> <span class="n">x_r</span><span class="p">,</span> <span class="kt">int</span><span class="p">[]</span> <span class="n">x_i</span><span class="p">){</span>
		<span class="n">real</span> <span class="n">velocity</span> <span class="o">=</span> <span class="n">z</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">real</span> <span class="n">theta</span> <span class="o">=</span> <span class="n">z</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="n">real</span> <span class="n">g</span> <span class="o">=</span> <span class="mf">9.81</span><span class="p">;</span>
		<span class="n">real</span> <span class="n">damping</span> <span class="o">=</span> <span class="mf">5e-1</span><span class="p">;</span>
		<span class="n">real</span> <span class="n">length</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
			
		<span class="n">real</span> <span class="n">dv_dt</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">g</span><span class="o">/</span><span class="n">length</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">-</span> <span class="n">damping</span><span class="o">*</span><span class="n">velocity</span><span class="p">;</span>
		<span class="n">real</span> <span class="n">dtheta_th</span> <span class="o">=</span> <span class="n">velocity</span><span class="p">;</span>
	
		<span class="k">return</span> <span class="p">{</span><span class="n">dv_dt</span><span class="p">,</span> <span class="n">dtheta_th</span><span class="p">};</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>where <code class="language-plaintext highlighter-rouge">dz_dt</code> returns</p>

<p>$ \begin{bmatrix} \frac{d v}{dt} \\ \frac{d\theta}{dt}\end{bmatrix} $</p>

<p>evaluated at a particular $\theta$ and $v$. <code class="language-plaintext highlighter-rouge">x_r</code> and <code class="language-plaintext highlighter-rouge">x_i</code> are unused arguments that could be used to provide additional arguments to the function. The ODE is solved in</p>

<figure class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="n">transformed</span> <span class="n">parameters</span><span class="p">{</span>
	<span class="n">real</span> <span class="n">z</span><span class="p">[</span><span class="n">N</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">integrate_ode_rk45</span><span class="p">(</span><span class="n">dz_dt</span><span class="p">,</span> <span class="n">z_init</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">rep_array</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">rep_array</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="mf">1e-6</span><span class="p">,</span> <span class="mf">1e-5</span><span class="p">,</span> <span class="mf">1e6</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>where the arguments to the ode solvers are provided by the <code class="language-plaintext highlighter-rouge">data</code> block:</p>

<figure class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="n">data</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="o">&lt;</span><span class="n">lower</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">&gt;</span> <span class="n">N</span><span class="p">;</span>		<span class="c1">//number of measurements</span>
	<span class="n">real</span> <span class="n">ts</span><span class="p">[</span><span class="n">N</span><span class="p">];</span>			<span class="c1">//the times at which measurements are taken</span>
	<span class="n">real</span> <span class="n">y_init</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>			<span class="c1">//initial measured </span>
	<span class="n">real</span> <span class="n">y</span><span class="p">[</span><span class="n">N</span><span class="p">,</span><span class="mi">2</span><span class="p">];</span>			<span class="c1">//measured velocity and theta</span>
	<span class="n">real</span> <span class="o">&lt;</span><span class="n">lower</span> <span class="o">=</span> <span class="mi">0</span><span class="o">&gt;</span> <span class="n">sigma</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>	<span class="c1">//sensor noise measurement standard deviation of velocity and theta</span>
<span class="p">}</span></code></pre></figure>

<p>$N$ in this case is the total measurement counts where the $i^{\text{th}}$ measurement is taken at time <code class="language-plaintext highlighter-rouge">ts[i]</code>. The measurements along with an initial guess known as the prior will be used to estimate the length. The assumed initial conditions provided in <code class="language-plaintext highlighter-rouge">y_init</code> and <code class="language-plaintext highlighter-rouge">y</code> are the measurements of $v$ and $\theta$. In <code class="language-plaintext highlighter-rouge">transformed parameters</code> the first two arguments of <code class="language-plaintext highlighter-rouge">rep_array(0.0,0), rep_array(0,0), 1e-6, 1e-5, 1e6</code> are <code class="language-plaintext highlighter-rouge">NULL</code> equivalent while the rest are ode solver specific. The user provided <code class="language-plaintext highlighter-rouge">data</code> variables <code class="language-plaintext highlighter-rouge">y_init</code> and <code class="language-plaintext highlighter-rouge">y</code> are related to internal parameters <code class="language-plaintext highlighter-rouge">z_init</code> in the <code class="language-plaintext highlighter-rouge">model</code> block.</p>

<figure class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="n">model</span> <span class="p">{</span>
	<span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">~</span> <span class="n">normal</span><span class="p">(</span><span class="mf">1.9</span><span class="p">,</span><span class="mf">0.1</span><span class="p">);</span>
	<span class="n">z_init</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">~</span> <span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.01</span><span class="p">);</span><span class="c1">//velocity</span>
	<span class="n">z_init</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">~</span> <span class="n">normal</span><span class="p">(</span><span class="n">pi</span><span class="p">()</span> <span class="o">-</span> <span class="mf">0.1</span><span class="p">,</span><span class="mf">0.01</span><span class="p">);</span><span class="c1">//theta</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="n">in</span> <span class="mi">1</span><span class="o">:</span><span class="mi">2</span><span class="p">){</span>
		<span class="n">y_init</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">~</span> <span class="n">normal</span><span class="p">((</span><span class="n">z_init</span><span class="p">[</span><span class="n">k</span><span class="p">]),</span><span class="n">sigma</span><span class="p">[</span><span class="n">k</span><span class="p">]);</span>
		<span class="n">y</span><span class="p">[,</span><span class="n">k</span><span class="p">]</span> <span class="o">~</span> <span class="n">normal</span><span class="p">(</span><span class="n">z</span><span class="p">[,</span><span class="n">k</span><span class="p">],</span><span class="n">sigma</span><span class="p">[</span><span class="n">k</span><span class="p">]);</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>The <code class="language-plaintext highlighter-rouge">model</code> block takes the state <code class="language-plaintext highlighter-rouge">z</code> solved for in <code class="language-plaintext highlighter-rouge">transformed parameters</code> and adds sensor noise. In addition, it provides initial guess or prior for the assumed pendulum length as well the initial conditions defined  in <code class="language-plaintext highlighter-rouge">z_init</code>. The full <code class="language-plaintext highlighter-rouge">.stan</code> file can be found in <a href="https://szonov.com/assets/pendulum.stan">pendulum.stan</a>.</p>

<p>To estimate parameters we need data to work with - that is the measurements. To generated the measurements, we first need to solve the DE model and then add noise to it. Consider the <code class="language-plaintext highlighter-rouge">matlab</code> script (scavanged version of <a href="https://wiki.math.uwaterloo.ca/sheets/matlab/html/stoch_pendulum_white.html">this</a>):</p>

<figure class="highlight"><pre><code class="language-matlab" data-lang="matlab"><span class="nb">rng</span><span class="p">(</span><span class="s1">'shuffle'</span><span class="p">);</span>

<span class="nb">length</span><span class="o">=</span><span class="mi">2</span><span class="p">;</span><span class="c1">%this is the parameter that is being estimate</span>
<span class="n">g</span><span class="o">=</span><span class="mf">9.81</span><span class="p">;</span>
<span class="n">damp</span><span class="o">=</span><span class="mf">5e-1</span><span class="p">;</span>
<span class="n">numsteps</span><span class="o">=</span><span class="mi">10</span><span class="p">;</span> <span class="c1">% Sets how many time steps between saves.</span>
<span class="n">numouts</span><span class="o">=</span><span class="mi">2000</span><span class="p">;</span> <span class="c1">% Sets the number of outputs.</span>
<span class="n">dt</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">;</span> <span class="c1">% Sets the time step.</span>
<span class="n">numens</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>

<span class="c1">%% Initial conditions</span>
<span class="n">theta</span><span class="o">=</span><span class="nb">pi</span><span class="o">-</span><span class="mf">0.01</span><span class="p">;</span>
<span class="n">v</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="c1">% Initially assume zero velocity.</span>
<span class="n">t</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

<span class="c1">%% Set up arrays for storage and store initial state</span>
<span class="n">thetas</span><span class="o">=</span><span class="nb">zeros</span><span class="p">(</span><span class="n">numouts</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">numens</span><span class="p">);</span>
<span class="n">vs</span><span class="o">=</span><span class="nb">zeros</span><span class="p">(</span><span class="n">numouts</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">numens</span><span class="p">);</span>
<span class="n">ts</span><span class="o">=</span><span class="nb">zeros</span><span class="p">(</span><span class="n">numouts</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<span class="n">thetas</span><span class="p">(</span><span class="mi">1</span><span class="p">,:)</span><span class="o">=</span><span class="n">theta</span><span class="p">;</span>
<span class="n">vs</span><span class="p">(</span><span class="mi">1</span><span class="p">,:)</span><span class="o">=</span><span class="n">v</span><span class="p">;</span>
<span class="n">ts</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">t</span><span class="p">;</span>

<span class="k">for</span> <span class="n">ii</span><span class="o">=</span><span class="mi">1</span><span class="p">:</span><span class="n">numouts</span>
    <span class="k">for</span> <span class="n">jj</span><span class="o">=</span><span class="mi">1</span><span class="p">:</span><span class="n">numsteps</span>
        <span class="c1">%Euler time step scheme</span>
        <span class="n">dtheta_dt</span><span class="o">=</span><span class="n">v</span><span class="p">;</span>
        <span class="n">dv_dt</span><span class="o">=-</span><span class="p">(</span><span class="n">g</span><span class="p">/</span><span class="nb">length</span><span class="p">)</span><span class="o">.*</span><span class="nb">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">-</span><span class="n">damp</span><span class="o">*</span><span class="n">v</span><span class="p">;</span>

        <span class="n">theta</span><span class="o">=</span><span class="n">theta</span><span class="o">+</span><span class="n">dt</span><span class="o">*</span><span class="n">dtheta_dt</span><span class="p">;</span>
        <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="o">+</span><span class="n">dt</span><span class="o">*</span><span class="n">dv_dt</span><span class="p">;</span>

        <span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="o">+</span><span class="n">dt</span><span class="p">;</span>
    <span class="k">end</span>
    <span class="n">thetas</span><span class="p">(</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">,:)</span><span class="o">=</span><span class="n">theta</span><span class="p">;</span>
    <span class="n">vs</span><span class="p">(</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">,:)</span><span class="o">=</span><span class="n">v</span><span class="p">;</span>
    <span class="n">ts</span><span class="p">(</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">t</span><span class="p">;</span>
<span class="k">end</span>

<span class="c1">%write stuff to csv file</span>
<span class="nb">rng</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="nb">csvwrite</span><span class="p">(</span><span class="s1">'pendulum.csv'</span><span class="p">,[</span><span class="n">ts</span><span class="p">,</span><span class="n">thetas</span><span class="p">(:,</span><span class="mi">1</span><span class="p">),</span><span class="n">vs</span><span class="p">(:,</span><span class="mi">1</span><span class="p">)])</span>
<span class="k">!</span><span class="nb">echo</span> <span class="s1">'time, theta, velocity'</span> <span class="o">&gt;</span> pend.csv
<span class="k">!</span><span class="nb">cat </span>pendulum.csv <span class="o">&gt;&gt;</span> pend.csv
<span class="k">!</span><span class="nb">rm </span>pendulum.csv

<span class="c1">%sensor noise parameters</span>
<span class="n">sensor_theta_std</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">;</span>
<span class="n">sensor_velocity_std</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">;</span>

<span class="n">noise_theta</span> <span class="o">=</span>  <span class="n">sensor_theta_std</span><span class="o">*</span><span class="nb">randn</span><span class="p">(</span><span class="nb">size</span><span class="p">(</span><span class="n">thetas</span><span class="p">(:,</span><span class="mi">1</span><span class="p">)));</span>
<span class="n">noise_velocity</span> <span class="o">=</span> <span class="n">sensor_velocity_std</span><span class="o">*</span><span class="nb">randn</span><span class="p">(</span><span class="nb">size</span><span class="p">(</span><span class="n">vs</span><span class="p">(:,</span><span class="mi">1</span><span class="p">)));</span>

<span class="nb">csvwrite</span><span class="p">(</span><span class="s1">'pendulum_noisy.csv'</span><span class="p">,[</span><span class="n">ts</span><span class="p">,</span><span class="n">thetas</span><span class="p">(:,</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">noise_theta</span><span class="p">,</span><span class="n">vs</span><span class="p">(:,</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">noise_velocity</span><span class="p">])</span>
<span class="k">!</span><span class="nb">echo</span> <span class="s1">'time, theta, velocity'</span> <span class="o">&gt;</span> pend_noisy.csv
<span class="k">!</span><span class="nb">cat </span>pendulum_noisy.csv <span class="o">&gt;&gt;</span> pend_noisy.csv
<span class="k">!</span><span class="nb">rm </span>pendulum_noisy.csv</code></pre></figure>

<p>This script creates a csv file <code class="language-plaintext highlighter-rouge">pend_noise.csv</code> with the noisy measurements of velocity and theta. A plot below shows the curve of $v$ and $\theta$ given that at time $t=0$</p>

<p>$v = 0$</p>

<p>$\theta = \pi - 0.01$</p>

<p><img src="https://szonov.com/assets/stan_pendulum1.png" alt="image" /></p>

<p>By time $20$ the state has been mostly damped out. We now have everything we need to estimate the length. We run <code class="language-plaintext highlighter-rouge">Stan</code> through <code class="language-plaintext highlighter-rouge">R</code>. The <code class="language-plaintext highlighter-rouge">R</code> script is below and can be found in <a href="https://szonov.com/assets/script.r">script.r</a>.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">library</span><span class="p">(</span><span class="s2">"rstan"</span><span class="p">)</span><span class="w">

</span><span class="n">pendulum_data</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read.csv</span><span class="p">(</span><span class="s2">"pend_noisy.csv"</span><span class="p">)</span><span class="w">
</span><span class="n">N</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="n">pendulum_data</span><span class="o">$</span><span class="n">time</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="n">sigma</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">0.1</span><span class="p">,</span><span class="m">0.1</span><span class="p">);</span><span class="c1">#velocity, theta std</span><span class="w">
</span><span class="n">ts</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">pendulum_data</span><span class="o">$</span><span class="n">time</span><span class="w">
</span><span class="n">ts</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ts</span><span class="p">[</span><span class="m">2</span><span class="o">:</span><span class="nf">length</span><span class="p">(</span><span class="n">pendulum_data</span><span class="o">$</span><span class="n">time</span><span class="p">)]</span><span class="w">
</span><span class="n">y_init</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">pendulum_data</span><span class="o">$</span><span class="n">velocity</span><span class="p">[</span><span class="m">1</span><span class="p">],</span><span class="n">pendulum_data</span><span class="o">$</span><span class="n">theta</span><span class="p">[</span><span class="m">1</span><span class="p">])</span><span class="w">
</span><span class="n">y</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">as.matrix</span><span class="p">(</span><span class="n">pendulum_data</span><span class="p">[</span><span class="m">2</span><span class="o">:</span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">pendulum_data</span><span class="o">$</span><span class="n">time</span><span class="p">)),</span><span class="m">2</span><span class="o">:</span><span class="m">3</span><span class="p">])</span><span class="w">
</span><span class="n">y</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">cbind</span><span class="p">(</span><span class="n">y</span><span class="p">[,</span><span class="m">2</span><span class="p">],</span><span class="n">y</span><span class="p">[,</span><span class="m">1</span><span class="p">])</span><span class="w">
</span><span class="n">pendulum</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="n">ts</span><span class="p">,</span><span class="n">y_init</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">sigma</span><span class="p">)</span><span class="w">


</span><span class="n">model</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">stan_model</span><span class="p">(</span><span class="s2">"pendulum.stan"</span><span class="p">)</span><span class="w">
</span><span class="n">fit</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sampling</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pendulum</span><span class="p">,</span><span class="w"> </span><span class="n">seed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">123</span><span class="p">,</span><span class="n">chains</span><span class="o">=</span><span class="m">4</span><span class="p">,</span><span class="n">iter</span><span class="o">=</span><span class="m">1000</span><span class="p">,</span><span class="w"> </span><span class="n">control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="n">adapt_delta</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.99</span><span class="p">))</span><span class="w">
</span><span class="n">print</span><span class="p">(</span><span class="n">fit</span><span class="p">,</span><span class="w"> </span><span class="n">pars</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="s2">"params"</span><span class="p">,</span><span class="s2">"z_init"</span><span class="p">),</span><span class="n">probs</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">0.1</span><span class="p">,</span><span class="m">0.5</span><span class="p">,</span><span class="m">0.9</span><span class="p">),</span><span class="n">digits</span><span class="o">=</span><span class="m">4</span><span class="p">)</span></code></pre></figure>

<p>In the terminal, open up <code class="language-plaintext highlighter-rouge">R</code> and run</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="o">&gt;</span><span class="w"> </span><span class="n">source</span><span class="p">(</span><span class="s2">"script.r"</span><span class="p">)</span></code></pre></figure>

<p>We now study a couple of cases:</p>

<p><strong>Case 1:</strong></p>

<p>The initial conditions used to generate the measurements and those in the prior are similair. Both the assumed in <code class="language-plaintext highlighter-rouge">Stan</code>’s <code class="language-plaintext highlighter-rouge">model</code> as well as the matlab script:</p>

<p>$\theta = \pi - 0.01$</p>

<p>$v = 0$</p>

<p>In <code class="language-plaintext highlighter-rouge">Stan</code> the conditions have an assumed variance of $0.01^2$ for each parameter. The pendulum length is $1.9$ with variance $0.1^2$ while the true pendulum is of length $2$. The results of the script are</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>           mean se_mean    sd    10%    50%   90% n_eff   Rhat
params[1] 1.866   0.054 0.076  1.820  1.823 1.998     2 39.819
z_init[1] 0.217   0.302 0.434 -0.038 -0.027 1.049     2 16.054
z_init[2] 1.452   0.527 0.746  1.017  1.023 2.762     2 66.696
</code></pre></div></div>

<p>The high <code class="language-plaintext highlighter-rouge">Rhat</code> suggests that something is wrong. Debugging <code class="language-plaintext highlighter-rouge">Stan</code> code and correctly interpreting the results is a lengthy topic not fully explored here. Further material can be found in the <code class="language-plaintext highlighter-rouge">mc-stan</code> forums or in books like “Bayesian Data Analysis Third Edition” by Gelman et. al. We run the following script in <code class="language-plaintext highlighter-rouge">R</code> to produce plots in order to further debug:</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">jpeg</span><span class="p">(</span><span class="s1">'posterior2.jpg'</span><span class="p">)</span><span class="w">
</span><span class="n">par</span><span class="p">(</span><span class="n">mfrow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">3</span><span class="p">,</span><span class="m">1</span><span class="p">))</span><span class="w">
</span><span class="n">posterior</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">extract</span><span class="p">(</span><span class="n">fit</span><span class="p">)</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">density</span><span class="p">(</span><span class="n">posterior</span><span class="o">$</span><span class="n">params</span><span class="p">),</span><span class="w"> </span><span class="n">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"length"</span><span class="p">)</span><span class="w">
</span><span class="n">abline</span><span class="p">(</span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">lty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">)</span><span class="w">
</span><span class="n">abline</span><span class="p">(</span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="m">1.867</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">lty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">)</span><span class="w">

</span><span class="n">init</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">posterior</span><span class="o">$</span><span class="n">z_init</span><span class="w">
</span><span class="n">init1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">init</span><span class="p">[,</span><span class="m">1</span><span class="p">]</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">density</span><span class="p">(</span><span class="n">init1</span><span class="p">),</span><span class="w"> </span><span class="n">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"velocity initial"</span><span class="p">)</span><span class="w">
</span><span class="n">abline</span><span class="p">(</span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">lty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">)</span><span class="w">
</span><span class="n">abline</span><span class="p">(</span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.003</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">lty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">)</span><span class="w">

</span><span class="n">init2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">init</span><span class="p">[,</span><span class="m">2</span><span class="p">]</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">density</span><span class="p">(</span><span class="n">init2</span><span class="p">),</span><span class="w"> </span><span class="n">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"theta initial"</span><span class="p">)</span><span class="w">
</span><span class="n">abline</span><span class="p">(</span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">lty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">)</span><span class="w">
</span><span class="n">abline</span><span class="p">(</span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3.041593</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">lty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">)</span><span class="w">
</span><span class="n">dev.off</span><span class="p">()</span><span class="w">

</span><span class="n">jpeg</span><span class="p">(</span><span class="s1">'theta2.jpg'</span><span class="p">)</span><span class="w">
</span><span class="n">z</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">posterior</span><span class="o">$</span><span class="n">z</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span><span class="n">z</span><span class="p">[</span><span class="m">1</span><span class="p">,,</span><span class="m">1</span><span class="p">],</span><span class="n">main</span><span class="o">=</span><span class="s2">"z"</span><span class="p">,</span><span class="n">xlim</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">20</span><span class="p">),</span><span class="n">ylim</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="o">-</span><span class="nb">pi</span><span class="p">,</span><span class="nb">pi</span><span class="p">),</span><span class="n">xlab</span><span class="o">=</span><span class="s1">'Time'</span><span class="p">,</span><span class="n">ylab</span><span class="o">=</span><span class="s1">'Theta'</span><span class="p">)</span><span class="w">
</span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="m">2000</span><span class="p">){</span><span class="w">
	</span><span class="n">print</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w">
	</span><span class="n">par</span><span class="p">(</span><span class="n">new</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span><span class="w">
	</span><span class="n">plot</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span><span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">,,</span><span class="m">1</span><span class="p">],</span><span class="n">add</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">,</span><span class="n">xlim</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">20</span><span class="p">),</span><span class="n">ylim</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="o">-</span><span class="nb">pi</span><span class="p">,</span><span class="nb">pi</span><span class="p">),</span><span class="n">xlab</span><span class="o">=</span><span class="s1">''</span><span class="p">,</span><span class="n">ylab</span><span class="o">=</span><span class="s1">''</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="n">dev.off</span><span class="p">()</span></code></pre></figure>

<p>The first plot is the computed by <code class="language-plaintext highlighter-rouge">Stan</code> posterior distribution of the length, initial velocity and initial theta. The red is the true initial state specified within the matlab script while black is the computed posterior mean. For both theta and velocity we see a multimodal distribution.</p>

<p><img src="https://szonov.com/assets/stan_posterior2.jpg" alt="image" /></p>

<p>The plot shows that there is no clear guess as to what the initial conditions or the lengths is. The overlay of all the computed simulated $\theta$ s by <code class="language-plaintext highlighter-rouge">Stan</code> in the non warm-up phase is below [hence the fat curves].</p>

<p><img src="https://szonov.com/assets/stan_theta2.jpg" alt="image" /></p>

<p>There are two main simulated trajectories of $\theta$. This is because the initial condition and its variance assumed in <code class="language-plaintext highlighter-rouge">Stan</code> in variable <code class="language-plaintext highlighter-rouge">z_init</code> is too close to $\pi$ as seen in figure below</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">jpeg</span><span class="p">(</span><span class="s1">'norm.jpg'</span><span class="p">)</span><span class="w">
</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rnorm</span><span class="p">(</span><span class="m">500000</span><span class="p">,</span><span class="nb">pi</span><span class="m">-0.01</span><span class="p">,</span><span class="m">0.01</span><span class="p">)</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">density</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="w">
</span><span class="n">abline</span><span class="p">(</span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">pi</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">lty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">)</span><span class="w">
</span><span class="n">dev.off</span><span class="p">()</span></code></pre></figure>

<p><img src="https://szonov.com/assets/stan_norm.jpg" alt="image" /></p>

<p>The red line is at $\pi$. Part of the area is over $\pi$ meaning that some conditions are less than $\pi$ while others are greater than. This results in two different types of behaviours of the pendulum swinging down leftwards or rightwards.</p>

<p>Although through the matlab script we technically know the true pendulum length, that knowledge is unknown to the <code class="language-plaintext highlighter-rouge">Stan</code> script. If the previous figures in <code class="language-plaintext highlighter-rouge">Stan</code> is all that we had to work with then we would have lack confidence in our estimate of the pendulum length.</p>

<p><strong>Case 2:</strong></p>

<p>The variance is now shrunk to avoid having significant probablity for initial $\theta$ greater than $\pi$ to match the actual physical initial conditions defined in matlab script [pendulum falling towards the left]. Variance is now $0.0001^2$ for the prior:</p>

<p><img src="https://szonov.com/assets/stan_norm2.jpg" alt="image" /></p>

<p>After running <code class="language-plaintext highlighter-rouge">Stan</code> again we obtain results that more closely match the true values of the parameters:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>           mean se_mean    sd   10%   50%   90% n_eff  Rhat
params[1] 1.999       0 0.002 1.997 1.999 2.001    63 1.000
z_init[1] 0.000       0 0.000 0.000 0.000 0.000   249 0.998
z_init[2] 3.132       0 0.000 3.132 3.132 3.132   154 1.001
</code></pre></div></div>

<p><img src="https://szonov.com/assets/stan_posterior1.jpg" alt="image" /></p>

<p>In conclusion, this somewhat contrived examples goes to show that knowledge of the priors and model is very important for conducting a successful experiment.</p>


  </article>

</div>

      </div>
    </div>

    <footer class="site-footer">

	<div class="wrapper">

		<!--<p style="color:grey">Welcome to my site. Take a look around and don't be shy, shoot me a message!</p>-->
	</div>
  <div class="wrapper">

    <h2 class="footer-heading">Stan Zonov</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-2">
        <ul class="contact-list">
          <!--<li>Stan Zonov</li>-->
          <li>hello at szonov.com</li>
        </ul>
      </div>

      <div class="footer-col  footer-col-1">
	     
        <ul class="social-media-list">
	   <!--
            <p>

<span class="icon  icon--github">
                <svg viewBox="0 0 16 16">
																	<g transform="scale(0.035)">
                  <path fill="#828282" d="M101.3 141.6v228.9h0.3 308.4 0.8V141.6H101.3zM375.7 167.8l-119.7 91.5 -119.6-91.5H375.7zM127.6 194.1l64.1 49.1 -64.1 64.1V194.1zM127.8 344.2l84.9-84.9 43.2 33.1 43-32.9 84.7 84.7L127.8 344.2 127.8 344.2zM384.4 307.8l-64.4-64.4 64.4-49.3V307.8z"/>
																</g>
                </svg>
              </span>

              <span class="username">hello at szonov.com</span>
	    </p>
	    </li>-->


          

          


          


        </ul>
      </div>

      <div class="footer-col  footer-col-3">
        <p class="text"></p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
